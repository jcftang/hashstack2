extends: [autotools_package]

dependencies:
  build: [gnu-sed, zlib]

sources:
- key: tar.gz:conmqheupcwm2ofj5nthmi6xlgl2egl4
  url: http://ftp.heanet.ie/pub/OpenBSD/LibreSSL/libressl-2.0.0.tar.gz

build_stages:

- name: configure
  when: platform == 'linux'
  extra: ['LDFLAGS=-lrt']

- files: [libressl-dummy-egd-functions.diff, libressl-remove-main-symbol.diff]
  name: patch
  handler: bash
  before: configure
  bash: |
    patch -p1 < _hashdist/libressl-dummy-egd-functions.diff
    patch -p1 < _hashdist/libressl-remove-main-symbol.diff

- name: install_pkg_config
  after: install
  files: [libcrypto.pc,libssl.pc,openssl.pc]
  handler: bash
  bash: |
    install -d -m 755 "${ARTIFACT}"/lib/pkgconfig
    install -c -m 755 _hashdist/libcrypto.pc "${ARTIFACT}"/lib/pkgconfig/libcrypto.pc
    install -c -m 755 _hashdist/libssl.pc "${ARTIFACT}"/lib/pkgconfig/libssl.pc
    install -c -m 755 _hashdist/openssl.pc "${ARTIFACT}"/lib/pkgconfig/openssl.pc
    sed -ie "s|^prefix=.*|prefix=$ARTIFACT|g" "${ARTIFACT}"/lib/pkgconfig/libcrypto.pc
    sed -ie "s|^prefix=.*|prefix=$ARTIFACT|g" "${ARTIFACT}"/lib/pkgconfig/libssl.pc
    sed -ie "s|^prefix=.*|prefix=$ARTIFACT|g" "${ARTIFACT}"/lib/pkgconfig/openssl.pc

when_build_dependency:
- prepend_path: PATH
  value: '${ARTIFACT}/bin'
- prepend_path: PKG_CONFIG_PATH
  value: '${ARTIFACT}/lib/pkgconfig'
